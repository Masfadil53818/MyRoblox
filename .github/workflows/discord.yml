name: UPDATESCRIPT

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read version
        run: echo "VERSION=$(cat version.txt | tr -d '\r')" >> $GITHUB_ENV

      - name: Send message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.UPDATESCRIPT }}
          CHANGELOG: ${{ github.event.head_commit.message }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          # fail early with clear message when secret is not set
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "ERROR: secret 'UPDATESCRIPT' is not set. Please add it in Settings -> Secrets -> Actions.";
            exit 1;
          fi

          # basic URL validation to catch obvious mistakes
          if ! echo "$DISCORD_WEBHOOK" | grep -Eq "https?://(canary\.)?discord(app)?\.com/api/webhooks/"; then
            echo "ERROR: secret 'UPDATESCRIPT' does not look like a Discord webhook URL.";
            echo "Value: $DISCORD_WEBHOOK";
            exit 1;
          fi

          # build JSON payload safely using Python to ensure proper escaping
          PAYLOAD=$(python - <<PY
import os, json
payload = {
  "username": "CornelloTeam",
  "embeds": [{
    "title": f"Update Script — CornelloTeam v{os.getenv('VERSION','unknown')}",
    "description": os.getenv('CHANGELOG','No changelog provided'),
    "color": 5763714,
    "fields": [
      {"name":"Version","value": os.getenv('VERSION','unknown'), "inline": True},
      {"name":"Changelog","value": os.getenv('CHANGELOG','').strip() or 'No changelog', "inline": False}
    ],
    "thumbnail": { "url": "https://ibb.co.com/9mxLgNg7" },
    "footer": {"text":"Public Update • CornelloTeam"},
    "timestamp": os.getenv('TIMESTAMP')
  }]
}
print(json.dumps(payload))
PY
)

          # DEBUG: print payload for inspection (will not reveal webhook)
          echo "PAYLOAD: $PAYLOAD"

          # send and check HTTP status
          HTTP_STATUS=$(curl -sS -w "%{http_code}" -o /dev/null -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" "$DISCORD_WEBHOOK")

          echo "Discord webhook returned HTTP $HTTP_STATUS"
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "Discord embed notification sent successfully.";
          else
            echo "ERROR: Discord webhook returned non-success status $HTTP_STATUS";
            exit 1;
          fi