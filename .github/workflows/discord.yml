name: UPDATESCRIPT

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        run: |
          echo "VERSION=$(tr -d '\r' < version.txt)" >> $GITHUB_ENV

      - name: Send stealth update to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.UPDATESCRIPT }}
          RAW_CHANGELOG: ${{ github.event.head_commit.message }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then exit 1; fi

          PAYLOAD=$(python3 -c "import os,json;raw=os.getenv('RAW_CHANGELOG','');lines=[l.strip() for l in raw.splitlines() if l.strip()];add=[];chg=[];fix=[];\
[add.append(l[1:].strip()) if l.startswith('+') else fix.append(l[1:].strip()) if l.startswith('/') else chg.append(l[1:].strip()) if l.startswith('-') else chg.append(l) for l in lines];\
blk=lambda t,i,v: '' if not v else f'[ {i} ] {t}\\n```'+'\\n'.join(v)+'```\\n';\
desc=(blk('ADD','+',add)+blk('CHANGE','â”€',chg)+blk('FIX','/',fix)).strip();\
print(json.dumps({'username':'Update Service','embeds':[{'title':f\"ðŸŽ® Game Script Update â€” v{os.getenv('VERSION','unknown')}\",'description':desc,'color':0x2B2D31,'footer':{'text':'Automated Update â€¢ Secure Channel'},'timestamp':os.getenv('TIMESTAMP')}]}))")

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK"
