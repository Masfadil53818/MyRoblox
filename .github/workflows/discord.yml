name: UPDATESCRIPT

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read version
        run: echo "VERSION=$(cat version.txt | tr -d '\r')" >> $GITHUB_ENV

      - name: Send Discord embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.UPDATESCRIPT }}
          CHANGELOG: ${{ github.event.head_commit.message }}
        run: |
          python << 'EOF'
          import os, json, subprocess

          changelog = os.getenv("CHANGELOG","").splitlines()

          add = [l[1:].strip() for l in changelog if l.startswith("+")]
          chg = [l[1:].strip() for l in changelog if l.startswith("-")]
          fix = [l[1:].strip() for l in changelog if l.startswith("/")]

          desc = f"Version: {os.getenv('VERSION','unknown')}\n"

          if add:
              desc += "\n[ + ] ADD\n```" + "\n".join(add) + "```"
          if chg:
              desc += "\n[ - ] CHANGE\n```" + "\n".join(chg) + "```"
          if fix:
              desc += "\n[ / ] FIX\n```" + "\n".join(fix) + "```"

          payload = {
              "content": "Game Script Updated",
              "embeds": [{
                  "description": desc,
                  "color": 3066993,
                  "thumbnail": {
                      "url": "https://i.ibb.co/9mxLgNg7/thumbnail.png"
                  }
              }]
          }

          subprocess.run([
              "curl","-X","POST",
              os.environ["DISCORD_WEBHOOK"],
              "-H","Content-Type: application/json",
              "-d", json.dumps(payload)
          ])
          EOF
