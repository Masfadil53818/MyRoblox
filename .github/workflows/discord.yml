name: UPDATESCRIPT

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        run: echo "VERSION=$(cat version.txt | tr -d '\r')" >> $GITHUB_ENV

      - name: Send stealth update to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.UPDATESCRIPT }}
          RAW_CHANGELOG: ${{ github.event.head_commit.message }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "ERROR: Webhook not set"
            exit 1
          fi

          PAYLOAD=$(python - << 'EOF'
import os, json

raw = os.getenv("RAW_CHANGELOG","").strip()

# Split lines from commit message
lines = [l.strip() for l in raw.splitlines() if l.strip()]

# Fallback if commit message is one line
if not lines:
    lines = ["minor internal update"]

add = []
chg = []
fix = []

for l in lines:
    low = l.lower()
    if low.startswith(("+", "[+]","add","adding")):
        add.append(l.lstrip("+[] ").strip())
    elif low.startswith(("-", "change","improve","update")):
        chg.append(l.lstrip("- ").strip())
    elif low.startswith(("/", "fix","fixed")):
        fix.append(l.lstrip("/ ").strip())
    else:
        chg.append(l)

def block(title, icon, items):
    if not items:
        return ""
    content = "\n".join(items)
    return f"[ {icon} ] {title}\n```{content}```\n"

description = (
    block("ADD", "+", add) +
    block("CHANGE", "â”€", chg) +
    block("FIX", "/", fix)
).strip()

payload = {
  "username": "Update Service",
  "avatar_url": "https://i.ibb.co/9mxLgNg7/thumbnail.png",
  "embeds": [
    {
      "title": f"ðŸŽ® Game Script Update â€” v{os.getenv('VERSION','unknown')}",
      "description": description,
      "color": 0x2B2D31,
      "fields": [
        {
          "name": "ðŸ“¦ Script Type",
          "value": "Game Script",
          "inline": True
        },
        {
          "name": "ðŸ” Build",
          "value": "Private",
          "inline": True
        }
      ],
      "footer": {
        "text": "Automated Update â€¢ Secure Channel"
      },
      "timestamp": os.getenv("TIMESTAMP")
    }
  ]
}

print(json.dumps(payload))
EOF
)

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "$DISCORD_WEBHOOK"
